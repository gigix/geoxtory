<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
<style type="text/css">
  html { height: 100% }
  body { height: 100%; margin: 0px; padding: 0px }
  #map_canvas{
   height:100%;
   width:75%;
  }
</style>

<%= javascript_include_tag :defaults, 'csv.js', 'http://www.google.com/jsapi' %>
	
<script type="text/javascript">
google.load('maps','3',{other_params:'sensor=false'}); // load the maps api

function initialize() {
	var map = createMap();	
	process("<%= url_for :controller => 'trips', :action => 'csv', :id => @trip %>", map);
}

function createMap() {	
	var myLatlng = new google.maps.LatLng(0, 0);
	var myOptions = {
		zoom: 4,
	    center: myLatlng,
	    mapTypeId: google.maps.MapTypeId.TERRAIN
	}
  	var map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);	
	return map;
}

function process(csv_file, map) {
	$.ajax({
	  type: 'GET',
	  url: csv_file,
	  cache: false,
	  success: function(csv){ 
		markLocations(csv, map);	
	  }
	});		
}

function markLocations(csv, map) {
	var latlngbounds = new google.maps.LatLngBounds();
	var infowindow = new google.maps.InfoWindow({
		maxWidth: 400,
		content: "doesn't matter..."
	});

	$.each(parseCSV(csv), function(index, location) {
		var point = new google.maps.LatLng(location['Lat'], location['Long']);
		latlngbounds.extend(point);
		
		var marker = new google.maps.Marker({
			position: point,
			map: map,
			title: location['Name'],
			html: '<h2><a href="' + location['URL'] + '" target="_blank">' + location['Name'] + '</a></h2><em>' + location['Description'] + '</em><p><img src="' + location['Thumb_URL'] + '" height="160px" /></p>'
		});
		
		google.maps.event.addListener(marker, "click", function(){
			infowindow.setContent(this.html);
			infowindow.open(map, this);
		});
	});
	map.fitBounds(latlngbounds);	
}

google.setOnLoadCallback(initialize);
</script>
</head>
<body>
	<header>
		<%= image_tag 'logo.gif' %>
	</header>
	<div class='main' style="width:100%; height:70%;">
  		<div id="map_canvas"></div>
		<div id="locations">
			<ul>
				<%= render :partial => 'location', :collection => @trip.locations %>
			</ul>
		</div>
		<div id="current_location">
			<% unless @trip.locations.blank? %>
			<%= image_tag @trip.locations.first.image_url %>
			<% end %>
		</div>
	</div>
	<footer>
	</footer>
</body>
</html>